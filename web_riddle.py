import streamlit as st
import random
import time

# è¨­å®šç¶²é æ¨™é¡Œ
st.set_page_config(page_title="å…ƒå®µé—–é—œå¤§æŒ‘æˆ°", page_icon="ğŸ®")

# --- 1. æ“´å……é¡Œåº« (æ¯é—œ 10 é¡Œ) ---
if 'game_initialized' not in st.session_state:
    raw_levels = {
        1: {
            "name": "ğŸŒ± ç¬¬ä¸€é—œï¼šç‰›åˆ€å°è©¦ (å…¥é–€)",
            "pool": [
                {"q": "ä¸€å€‹è€é ­å­ï¼Œé ­ä¸Šé•·é¬å­ï¼Œè„«ä¸‹ç¶ è¢å­ï¼Œæ»¿èº«é‡‘ç å­ã€‚ï¼ˆçŒœä¸€æ¤ç‰©ï¼‰", "a": "ç‰ç±³", "hint": "é»ƒè‰²çš„ï¼Œä¸€ç²’ä¸€ç²’"},
                {"q": "èº«ç©¿ç¶ è¡£è£³ï¼Œè‚šè£¡ç´…ç“¤å­ï¼Œç”Ÿçš„å…’å­å¤šï¼Œå€‹å€‹é»‘è‡‰å­ã€‚ï¼ˆçŒœä¸€æ°´æœï¼‰", "a": "è¥¿ç“œ", "hint": "å¤å¤©æ¶ˆæš‘è–å“"},
                {"q": "ç´…ç´…å°è‡‰ä¼¼è˜‹æœï¼Œé›–ç„¶æ‰é€²æ°´ç«è£¡ï¼Œæœ€å¾Œå»è®Šç™½èƒ–å­ã€‚ï¼ˆçŒœä¸€æ‡‰æ™¯é£Ÿç‰©ï¼‰", "a": "å…ƒå®µ", "hint": "åœ“åœ“çš„ï¼Œç”œç”œçš„"},
                {"q": "é•·é•·è€³æœµç´…çœ¼ç›ï¼Œèµ°è·¯æ„›è·³ä¸æ„›è·‘ã€‚ï¼ˆçŒœä¸€å‹•ç‰©ï¼‰", "a": "å…”å­", "hint": "æ„›åƒèƒ¡è˜¿è””"},
                {"q": "å¹´ç´€ä¸¦ä¸å¤§ï¼Œé¬å­ä¸€æŠŠæŠ“ï¼Œä¸è«–é‡åˆ°èª°ï¼Œç¸½æ„›å–Šåª½åª½ã€‚ï¼ˆçŒœä¸€å‹•ç‰©ï¼‰", "a": "ç¾Š", "hint": "æœƒç”¢ç¾Šä¹³"},
                {"q": "ä¸€éš»é³¥å…’é†œï¼Œç”Ÿä¾†æ„›å–é…’ï¼Œå–äº†å…©å£é…’ï¼Œå”±èµ·æ­Œä¾†æŠ–ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "é…", "hint": "é…’ = é…‰ï¼Œé³¥ = å·±...ä¸å°ï¼Œæ˜¯é…‰+å·±"},
                {"q": "åƒæ‰‹ä¸æ˜¯æ‰‹ï¼Œè·¯é‚Šåˆ°è™•èµ°ï¼Œé›–ç„¶ä¸æœƒå«ï¼Œå»æ˜¯å¥½å¹«æ‰‹ã€‚ï¼ˆçŒœä¸€äº¤é€šå·¥å…·ï¼‰", "a": "æ‰‹æ¨è»Š", "hint": "å·¥åœ°å¸¸çœ‹åˆ°"},
                {"q": "ä¸€æ£µå°æ¨¹ä¸é«˜ï¼Œçµçš„æœå¯¦åƒæŠŠåˆ€ã€‚ï¼ˆçŒœä¸€è”¬èœï¼‰", "a": "è±†è§’", "hint": "ç¶ è‰²çš„ï¼Œé•·é•·çš„"},
                {"q": "ç™½å¤©é–‹èŠ±ï¼Œæ™šä¸Šæ”¶èŠ±ï¼Œå®¶å®¶æˆ¶æˆ¶ï¼Œéƒ½è¦ç”¨å®ƒã€‚ï¼ˆçŒœä¸€ç”Ÿæ´»ç”¨å“ï¼‰", "a": "ç‡ˆ", "hint": "æœƒç™¼å…‰"},
                {"q": "å°æ–¹ç›’ï¼Œäº®é–ƒé–ƒï¼Œæœƒèªªè©±ï¼Œæœƒè·³èˆã€‚ï¼ˆçŒœä¸€å®¶é›»ï¼‰", "a": "é›»è¦–", "hint": "å®¢å»³çš„ä¸»è§’"}
            ]
        },
        2: {
            "name": "ğŸ”¥ ç¬¬äºŒé—œï¼šæ¼¸å…¥ä½³å¢ƒ (é€²éš)",
            "pool": [
                {"q": "å·¦é‚Šç¶ ï¼Œå³é‚Šç´…ï¼Œå·¦å³ç›¸é‡èµ·æ¶¼é¢¨ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "ç§‹", "hint": "ç¦¾+ç«"},
                {"q": "ä¸€éš»å…«å¯¶è¢‹ï¼Œæ¨£æ¨£éƒ½èƒ½è£ã€‚èƒ½è½åˆèƒ½èªªï¼Œèªªè©±éŸ¿å™¹å™¹ã€‚ï¼ˆçŒœä¸€é›»å­ç”¢å“ï¼‰", "a": "æ‰‹æ©Ÿ", "hint": "ç¾ä»£äººé›¢ä¸é–‹å®ƒ"},
                {"q": "æ²’å˜´æœƒèªªè©±ï¼Œæ²’è…³æœƒèµ°è·¯ï¼Œå¤©å¤©æé†’æˆ‘ï¼Œæ—©èµ·å»è®€æ›¸ã€‚ï¼ˆçŒœä¸€ç”Ÿæ´»ç”¨å“ï¼‰", "a": "é¬§é˜", "hint": "æœƒå®åš€ä½ èµ·åºŠ"},
                {"q": "ä¸€äººèµ°é€²å»ï¼Œå…©äººæ’è‘—å®ƒï¼Œå¤©æ™´æ²’å®ƒäº‹ï¼Œä¸‹é›¨æ‰å¸¶å®ƒã€‚ï¼ˆçŒœä¸€ç‰©å“ï¼‰", "a": "å‚˜", "hint": "æ“‹é›¨ç”¨çš„"},
                {"q": "ç™½ç™½èƒ–èƒ–å°å¯¶å¯¶ï¼Œä¸€ç”Ÿä¸‹ä¾†å°±æ´—æ¾¡ã€‚ï¼ˆçŒœä¸€ç‰©å“ï¼‰", "a": "è‚¥çš‚", "hint": "æ´—æ‰‹ç”¨çš„"},
                {"q": "å¼Ÿå…„äº”å…­å€‹ï¼Œåœè‘—æŸ±å­åï¼Œå¤§å®¶ä¸€åˆ†æ‰‹ï¼Œè¡£æœéƒ½æ‰¯ç ´ã€‚ï¼ˆçŒœä¸€æ¤ç‰©ï¼‰", "a": "å¤§è’œ", "hint": "å‘³é“å¾ˆé‡ï¼Œç™½è‰²"},
                {"q": "ä¸€å€‹å…¬å…¬ç²¾ç¥å¥½ï¼Œå¤©å¤©æ—©èµ·æ²’ç…©æƒ±ï¼Œè¬ä¸ˆå…‰èŠ’ç…§å¤§åœ°ï¼Œæ²’ä»–è¬ç‰©æ´»ä¸äº†ã€‚ï¼ˆçŒœä¸€è‡ªç„¶ç‰©ï¼‰", "a": "å¤ªé™½", "hint": "ç™½å¤©å‡ºç¾"},
                {"q": "é«˜é«˜å€‹å­å…¨èº«é»ƒï¼Œæ„›å‘å¤ªé™½éœ²ç¬‘è‡‰ã€‚ï¼ˆçŒœä¸€èŠ±å‰ï¼‰", "a": "å‘æ—¥è‘µ", "hint": "ç¨®å­å¯ä»¥åƒ"},
                {"q": "åƒæ¢ç·šï¼Œè¬æ¢ç·šï¼Œæ‰é€²æ°´è£¡çœ‹ä¸è¦‹ã€‚ï¼ˆçŒœä¸€è‡ªç„¶ç¾è±¡ï¼‰", "a": "é›¨", "hint": "å¾å¤©è€Œé™"},
                {"q": "é çœ‹åƒå°è±¹ï¼Œè¿‘çœ‹è²“è²“å«ï¼Œæ„›åœ¨æ¨¹ä¸Šè·‘ï¼Œæœ¬é ˜çœŸä¸å°ã€‚ï¼ˆçŒœä¸€å‹•ç‰©ï¼‰", "a": "çŸ³è™", "hint": "å°ç£ä¿è‚²é¡å‹•ç‰©"}
            ]
        },
        3: {
            "name": "ğŸ† ç¬¬ä¸‰é—œï¼šç™»å³°é€ æ¥µ (å¤§å¸«)",
            "pool": [
                {"q": "å…©é»æ°´ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "å†°", "hint": "æ°´çµå‡äº†"},
                {"q": "ä¸€å£åƒæ‰ç‰›å°¾å·´ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "å‘Š", "hint": "ä¸Šé¢æ˜¯ç‰›ï¼Œä¸‹é¢æ˜¯å£"},
                {"q": "ä¸ƒåäºŒå°æ™‚ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "æ™¶", "hint": "ä¸‰å€‹æ—¥"},
                {"q": "å®ˆé–€å“¡ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "é–ƒ", "hint": "é–€è£¡é¢æœ‰äºº"},
                {"q": "å¿ƒå¦‚åˆ€å‰²ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "å¿", "hint": "å¿ƒä¸Šé¢æœ‰æŠŠåˆ€"},
                {"q": "çš‡å¸çš„æ–°è¡£ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "è¥²", "hint": "é¾çš„è¡£æœ"},
                {"q": "ä¸€å®¶æœ‰å››å£ï¼Œé‚„è¦é¤Šéš»ç‹—ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "å™¨", "hint": "å››å€‹å£+å¤§(çŠ¬)"},
                {"q": "åŠæ¨åŠå°±ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "æ ", "hint": "æ‰‹éƒ¨+äº¬"},
                {"q": "æ‹¿ä¸å‡ºæ‰‹ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "åˆ", "hint": "æ¨å»æ‰‹å­—é‚Š"},
                {"q": "é ‚å¤©ç«‹åœ°ã€‚ï¼ˆçŒœä¸€å­—ï¼‰", "a": "ç‹", "hint": "ä¸€æ©«ä¸€è±ä¸€æ©«ä¸€æ©«"}
            ]
        }
    }

    # æ¯å€‹é—œå¡éš¨æ©ŸæŒ‘é¸ 10 é¡Œ
    st.session_state.levels = {}
    for i in [1, 2, 3]:
        shuffled = random.sample(raw_levels[i]["pool"], 10)
        st.session_state.levels[i] = {
            "name": raw_levels[i]["name"],
            "questions": shuffled
        }

    st.session_state.current_level = 1
    st.session_state.correct_in_level = 0
    st.session_state.total_score = 0
    st.session_state.game_finished = False
    st.session_state.game_initialized = True

# --- 2. éŠæˆ²ä»‹é¢ ---
st.title("ğŸ® å…ƒå®µç‡ˆè¬é—–é—œå¤§æŒ‘æˆ°")

if not st.session_state.game_finished:
    lv = st.session_state.current_level
    current_lv_data = st.session_state.levels[lv]
    
    st.header(f"ç•¶å‰é€²åº¦ï¼š{current_lv_data['name']}")
    
    # é¡¯ç¤ºé€²åº¦æ¢
    progress = st.session_state.correct_in_level / 3
    st.progress(progress)
    st.write(f"æœ¬é—œç›®æ¨™ï¼šç­”å° 3 é¡Œ (ç›®å‰å·²ç­”å°: **{st.session_state.correct_in_level}** é¡Œ)")

    # å–å¾—ç•¶å‰é¡Œç›®
    q_idx = st.session_state.correct_in_level
    current_q = current_lv_data["questions"][q_idx]

    with st.container(border=True):
        st.subheader(f"é¡Œç›® {q_idx + 1}ï¼š")
        st.markdown(f"### {current_q['q']}")
        
        user_ans = st.text_input("åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆï¼š", key=f"q_{lv}_{q_idx}").strip()
        
        col1, col2 = st.columns([1, 4])
        with col1:
            if st.button("æäº¤ç­”æ¡ˆ"):
                if user_ans == current_q['a']:
                    st.session_state.correct_in_level += 1
                    st.session_state.total_score += 1
                    
                    if st.session_state.correct_in_level >= 3:
                        # éé—œè™•ç†
                        if lv < 3:
                            st.success(f"âœ¨ æ­å–œé€šé {current_lv_data['name']}ï¼")
                            # åˆ†ç´šç‰¹æ•ˆ
                            if lv == 1:
                                st.balloons() # ç°¡å–®ï¼šæ°£çƒ
                            elif lv == 2:
                                st.balloons() # é€²éšï¼šæ°£çƒ+é›ª
                                st.snow()
                                st.toast("ğŸš€ æº–å‚™è¿æ¥å¤§å¸«ç´šæŒ‘æˆ°ï¼", icon="ğŸ”¥")
                            
                            time.sleep(2)
                            st.session_state.current_level += 1
                            st.session_state.correct_in_level = 0
                        else:
                            st.session_state.game_finished = True
                        st.rerun()
                    else:
                        st.success("âœ… ç­”å°äº†ï¼ç¹¼çºŒä¸‹ä¸€é¡Œï¼")
                        time.sleep(1)
                        st.rerun()
                else:
                    if user_ans != "":
                        st.error("âŒ ä¸å¤ªå°å–”ï¼Œå†è§€å¯Ÿä¸€ä¸‹é¡Œç›®ï¼")
        
        with col2:
            if st.button("ğŸ’¡ æ‹¿æç¤º"):
                st.warning(f"å°æç¤ºï¼š{current_q['hint']}")

else:
    # --- 3. çµ‚æ¥µé€šé—œç•«é¢ (æœ€è¯éº—) ---
    st.balloons()
    st.snow()
    st.markdown("<h1 style='text-align: center; color: #FF4B4B;'>ğŸ† æ­å–œæˆç‚ºã€ç‡ˆè¬å¤§å®—å¸«ã€‘ï¼</h1>", unsafe__allow_html=True)
    st.write(f"ä½ æˆåŠŸåœ¨ä¸‰å€‹é—œå¡ä¸­éé—œæ–¬å°‡ï¼Œç¸½å…±ç­”å°äº† {st.session_state.total_score} é¡Œã€‚")
    
    # åŠ å…¥ä¸€å€‹æ›´ç²¾å½©çš„æ…¶ç¥å‹•åœ–
    st.image("https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHYybm9sY2p6Z3ZxdnEzdnN4Z3ZxdnEzdnN4Z3ZxdnEzdnN4Z3ZxdnEmeT1n/l0MYt5jPR6QX5pnqM/giphy.gif", use_container_width=True)
    
    if st.button("é‡æ–°é–‹å§‹æ–°çš„éš¨æ©ŸæŒ‘æˆ°"):
        del st.session_state['game_initialized']
        st.rerun()

# --- å´é‚Šæ¬„ ---
with st.sidebar:
    st.write("### ğŸ® ç©æ³•èªªæ˜")
    st.write("1. æ¯å€‹é—œå¡å¾ 10 é¡Œé¡Œåº«ä¸­éš¨æ©Ÿé¸é¡Œã€‚")
    st.write("2. åªè¦ç­”å° **3 é¡Œ** å³å¯é€²å…¥ä¸‹ä¸€é—œã€‚")
    st.write("3. é—œå¡è¶Šé«˜ï¼Œç‰¹æ•ˆè¶Šè±å¯Œï¼")
    st.divider()
    st.write("â›³ ç¥æ˜å¤© 1/10 å¤§å´—å±±çƒå ´æŠ“é³¥æˆåŠŸï¼")
